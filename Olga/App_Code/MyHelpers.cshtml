@using Olga.DAL.Entities
@using Olga.Models
@using System.Globalization

@helper MakeEditFiles(ProcedureViewModel procedureViewModel, ProcedureDocsType procedureDocsType)
{
    <span class="doc_type_name">@GetFileTypeText(procedureDocsType)</span>
    <br />
    <br />
    var archivedFiles = procedureViewModel?.ProcedureDocuments.Where(a => a.IsArchived).ToList();
    var nonArchivedFiles = procedureViewModel?.ProcedureDocuments.Where(a => !a.IsArchived).ToList();

    if (nonArchivedFiles != null)
    {
        foreach (var document in nonArchivedFiles)
        {
            if (document.ProcedureDocsType == @procedureDocsType)
            {
                @MakeDivForFiles(document)
            }
        }
    }
    <hr />
    if (archivedFiles != null)
    {
        <p><span>Archived files:</span></p>
        foreach (var document in archivedFiles)
        {
            if (document.ProcedureDocsType == @procedureDocsType)
            {
                @MakeDivForFiles(document)
            }
        }
    }
}

@helper MakeDivForFiles(ProcedureDocument document)
{
    var archiveClass = document.IsArchived ? "archiveOut" : "archive";
    var archiveToolTip = document.IsArchived ? "Get file from archive" : "Archive file";

    <div style="display: table; height: 70px; overflow: hidden;">
        <div style="display: table-cell; vertical-align: middle;">
            <a href="~/Upload/Documents/Procedures/@document.PathToDocument">@document.PathToDocument.Replace(@"/Archives/", "")</a>

            <a href="#" id="@document.Id" class="delete" title="Delete file">
                <img src="../../Content/images/remove.png" />
            </a>

            <a href="#" id="@document.Id" class="@archiveClass" data-isArchive="@document.IsArchived" tooltip="@archiveToolTip" title="@archiveToolTip">
                <img />
            </a>

            <img id="load_@document.Id" style="visibility: hidden; height: 30px; margin-left: 15px;" src="~/Content/images/loader.gif">
        </div>
        <br />
    </div>
}


@helper  GetFileTypeText(ProcedureDocsType procedureDocsType)
{
    switch (procedureDocsType)
    {
        case ProcedureDocsType.DossierObtainedFromM:
            @Resources.ProcedureDocsTypes.DossierObtainedFromM
            break;
        case ProcedureDocsType.DossierSubmittedToAuth:
            @Resources.ProcedureDocsTypes.DossierSubmittedToAuth
            break;
        case ProcedureDocsType.RemarksFromAuth:
            @Resources.ProcedureDocsTypes.RemarksFromAuth
            break;
        case ProcedureDocsType.RemarksToAuth:
            @Resources.ProcedureDocsTypes.RemarksToAuth
            break;
    }
}

@helper MakeViewFiles(ProcedureViewModel procedureViewModel)
{
    var procedureDocsTypes = Enum.GetValues(typeof(ProcedureDocsType));

    foreach (var procedureDocsType in procedureDocsTypes)
    {

        if (User.IsInRole("Admin") || User.IsInRole("Manager"))
        {
            <a href="/Procedure/EditFiles/@procedureViewModel.Id?productId=@procedureViewModel.ProductId&procedureDocsType=@procedureDocsType">@GetFileTypeText((ProcedureDocsType)procedureDocsType)</a>
        }
        else
        {
            <span>@GetFileTypeText((ProcedureDocsType)procedureDocsType)</span>
        }
        <br />
        <br />
        foreach (var document in procedureViewModel.ProcedureDocuments)
        {
            var docDate = document.DownloadDt != null ? $"[{document.DownloadDt.Value.ToShortDateString()}]" : "[no date]";
            if (document.ProcedureDocsType == (ProcedureDocsType)procedureDocsType)
            {

                <i class="glyphicon glyphicon-file"></i>
                <span>@docDate</span>
                <a class="docs_link" href="~/Upload/Documents/Procedures/@document.PathToDocument">@document.PathToDocument.Replace(@"/Archives/", "")</a>
                <br />
            }
        }
        <hr />
    }
}

@helper MakeProductInfoField()
{
    <span class="productInfo" id="PharmaceuticalForm"><img src="../../Content/images/loader.gif" /></span>
    <span class="productInfo" id="Strength"><img src="../../Content/images/loader.gif" /></span>
    <span class="productInfo" id="MarketingAuthorizNumber"><img src="../../Content/images/loader.gif" /></span>
    <span class="productInfo" id="ProductCode"><img src="../../Content/images/loader.gif" /></span>
}

